# Data transformation

First, let's take a look at our raw data. Take alt as an example, it contains 10 columns. Columns 1-4 provide different formats of dates, so we keep only the year and month columns. Columns 5-10 are monthly CO2 concentrations in different versions that have been adjusted. We only use column 5 in this project because it is the most standard. 

```{r}
alt = read.csv("./data/monthly_flask_co2_alt.csv")
alt[13:22,]
```

So we select year, month, and CO2 ppm columns and rename the last column to the station name because we have C02 concentration data for different stations and we need to separate them. This is what the dataset looks like after our selection.

```{r}
library(dplyr)
alt_mn <- select(alt, Yr, Mn, CO2..ppm.)
alt_mn <- rename(alt_mn, alt = CO2..ppm.)
alt_mn[13:22,]
```

Then we do the same thing for all the stations of different locations.

```{r}
mlo = read.csv("./data/monthly_flask_co2_mlo.csv")
mlo_mn <- select(mlo, Yr, Mn, CO2..ppm.)
mlo_mn <- rename(mlo_mn, mlo = CO2..ppm.)
kum = read.csv("./data/monthly_flask_co2_kum.csv")
kum_mn <- select(kum, Yr, Mn, CO2..ppm.)
kum_mn <- rename(kum_mn, kum = CO2..ppm.)
chr = read.csv("./data/monthly_flask_co2_chr.csv")
chr_mn <- select(chr, Yr, Mn, CO2..ppm.)
chr_mn <- rename(chr_mn, chr = CO2..ppm.)
sam = read.csv("./data/monthly_flask_co2_sam.csv")
sam_mn <- select(sam, Yr, Mn, CO2..ppm.)
sam_mn <- rename(sam_mn, sam = CO2..ppm.)
ker = read.csv("./data/monthly_flask_co2_ker.csv")
ker_mn <- select(ker, Yr, Mn, CO2..ppm.)
ker_mn <- rename(ker_mn, ker = CO2..ppm.)
nzd = read.csv("./data/monthly_flask_co2_nzd.csv")
nzd_mn <- select(nzd, Yr, Mn, CO2..ppm.)
nzd_mn <- rename(nzd_mn, nzd = CO2..ppm.)
```

Next we do an outer join by year and month columns for all the stations, and we have formed the new dataset “monthly_flask_co2” so far.

```{r}
monthly_co2 <- merge(alt_mn,mlo_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,kum_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,chr_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,sam_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,ker_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,nzd_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2[625:634,]
#write.csv(monthly_co2,"./data/monthly_flask_co2.csv")
```

Since we don't have categorical variables in our data, we want to add two categorical variables. Firstly, we change the numerical value of months to categories, such as January and February. Secondly, we separate our stations into two categories, in the northern hemisphere and in the southern hemisphere. Here is our data "monthly_co2_c".

```{r}
monthly_co2_c <- monthly_co2
monthly_co2_c$Mn <- month.abb[monthly_co2$Mn]
monthly_co2_c_tidy <- monthly_co2_c %>%
  pivot_longer(cols = -c(Yr,Mn), names_to = "station", 
               values_to = "CO2_concentration")
monthly_co2_c_tidy$hemisphere <- ifelse(monthly_co2_c_tidy$station %in% c('alt','mlo','kum','chr'), 'northern', 'southern')
monthly_co2_c_tidy[4369:4378,]
#write.csv(monthly_co2_c_tidy,"./data/monthly_co2_c_tidy.csv")
```

Since one of our goals is to study the impact of COVID-19 on CO2 concentrations, we need to filter the date during COVID-19, which is from March 2020 to now. Here is our data "covid_co2".

```{r}
covid_co2 <- filter(monthly_co2, (Yr == 2020 & Mn >= 3) | Yr == 2021)
covid_co2_tidy <- covid_co2 %>%
  pivot_longer(cols = -c(Yr,Mn), names_to = "station", 
               values_to = "CO2_concentration")
covid_co2_tidy[1:10,]
#write.csv(covid_co2_tidy,"./data/covid_co2_tidy.csv")
```

In addition, we want to get the yearly CO2 concentrations for all the stations. So we aggregate station columns and get the average of all the months. Here is our data “yearly_co2”.

```{r}
library(tidyr)
alt_yr <- aggregate(alt~Yr,monthly_co2,mean)
mlo_yr <- aggregate(mlo~Yr,monthly_co2,mean)
kum_yr <- aggregate(kum~Yr,monthly_co2,mean)
chr_yr <- aggregate(chr~Yr,monthly_co2,mean)
sam_yr <- aggregate(sam~Yr,monthly_co2,mean)
ker_yr <- aggregate(ker~Yr,monthly_co2,mean)
nzd_yr <- aggregate(nzd~Yr,monthly_co2,mean)
yearly_co2 <- merge(alt_yr,mlo_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,kum_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,chr_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,sam_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,ker_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,nzd_yr,all=TRUE)
yearly_co2_tidy <- yearly_co2 %>%
  pivot_longer(cols = !Yr, names_to = "station", 
               values_to = "CO2_concentration")
yearly_co2_tidy[365:374,]
#write.csv(yearly_co2_tidy,"./data/yearly_co2_tidy.csv")
```

Besides the yearly CO2 concentrations, we also want to get the ratio of CO2 concentrations this year to last year for all the stations. Here is our data “yearly_co2_ratio”.

```{r}
yearly_co2$ratio_alt <- yearly_co2$alt / shift(yearly_co2$alt)
yearly_co2$ratio_mlo <- yearly_co2$mlo / shift(yearly_co2$mlo)
yearly_co2$ratio_kum <- yearly_co2$kum / shift(yearly_co2$kum)
yearly_co2$ratio_chr <- yearly_co2$chr / shift(yearly_co2$chr)
yearly_co2$ratio_sam <- yearly_co2$sam / shift(yearly_co2$sam)
yearly_co2$ratio_ker <- yearly_co2$ker / shift(yearly_co2$ker)
yearly_co2$ratio_nzd <- yearly_co2$nzd / shift(yearly_co2$nzd)
yearly_co2_ratio <- yearly_co2[,c(1,9:15)]
yearly_co2_ratio <- rename(yearly_co2_ratio, alt = ratio_alt)
yearly_co2_ratio <- rename(yearly_co2_ratio, mlo = ratio_mlo)
yearly_co2_ratio <- rename(yearly_co2_ratio, kum = ratio_kum)
yearly_co2_ratio <- rename(yearly_co2_ratio, chr = ratio_chr)
yearly_co2_ratio <- rename(yearly_co2_ratio, sam = ratio_sam)
yearly_co2_ratio <- rename(yearly_co2_ratio, ker = ratio_ker)
yearly_co2_ratio <- rename(yearly_co2_ratio, nzd = ratio_nzd)
yearly_co2_ratio_tidy <- yearly_co2_ratio %>%
  pivot_longer(cols = -Yr, names_to = "station", 
               values_to = "CO2_concentration_ratio")
yearly_co2_ratio_tidy[365:374,]
#write.csv(yearly_co2_ratio_tidy,"./data/yearly_co2_ratio.csv")
```
