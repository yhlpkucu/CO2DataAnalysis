# Data transformation

First, let's take a look at our raw data. Take alt as an example, it contains 10 columns. Columns 1-4 provide different formats of dates, so we keep only the year and month columns. Columns 5-10 are monthly CO2 concentrations in different versions that have been adjusted. We only use column 5 in this project because it is the most standard. 

```{r}
alt = read.csv("./data/monthly_flask_co2_alt.csv")
alt[1:10,]
```

So we select year, month, and CO2 ppm columns and rename the last column to the station name because we have C02 concentration data for different stations and we need to separate them. This is what the dataset looks like after our selection.

```{r}
library(dplyr)
alt_mn <- select(alt, Yr, Mn, CO2..ppm.)
alt_mn <- rename(alt_mn, alt = CO2..ppm.)
alt_mn[1:10,]
```

Then we do the same thing for all the stations of different locations.

```{r}
mlo = read.csv("./data/monthly_flask_co2_mlo.csv")
mlo_mn <- select(mlo, Yr, Mn, CO2..ppm.)
mlo_mn <- rename(mlo_mn, mlo = CO2..ppm.)
kum = read.csv("./data/monthly_flask_co2_kum.csv")
kum_mn <- select(kum, Yr, Mn, CO2..ppm.)
kum_mn <- rename(kum_mn, kum = CO2..ppm.)
chr = read.csv("./data/monthly_flask_co2_chr.csv")
chr_mn <- select(chr, Yr, Mn, CO2..ppm.)
chr_mn <- rename(chr_mn, chr = CO2..ppm.)
sam = read.csv("./data/monthly_flask_co2_sam.csv")
sam_mn <- select(sam, Yr, Mn, CO2..ppm.)
sam_mn <- rename(sam_mn, sam = CO2..ppm.)
ker = read.csv("./data/monthly_flask_co2_ker.csv")
ker_mn <- select(ker, Yr, Mn, CO2..ppm.)
ker_mn <- rename(ker_mn, ker = CO2..ppm.)
nzd = read.csv("./data/monthly_flask_co2_nzd.csv")
nzd_mn <- select(nzd, Yr, Mn, CO2..ppm.)
nzd_mn <- rename(nzd_mn, nzd = CO2..ppm.)
```

Next we do an outer join by year and month columns for all the stations, and we have formed the new dataset “monthly_flask_co2” so far.

```{r}
monthly_co2 <- merge(alt_mn,mlo_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,kum_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,chr_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,sam_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,ker_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2 <- merge(monthly_co2,nzd_mn,by=c("Yr","Mn"),all=TRUE)
monthly_co2[613:622,]
```

Since one of our goals is to study the impact of COVID-19 on CO2 concentrations, we need to filter the date during COVID-19, which is from March 2020 to now. Here is our data "covid_co2".

```{r}
covid_co2 <- filter(monthly_co2, (Yr == 2020 & Mn >= 3) | Yr == 2021)
covid_co2_tidy <- covid_co2 %>%
  pivot_longer(cols = -c(Yr,Mn), names_to = "station", 
               values_to = "CO2_concentration")
covid_co2_tidy[1:10,]
write.csv(covid_co2_tidy,"./data/covid_co2_tidy.csv")
```


In addition, we want to get the yearly CO2 concentrations for all the stations. So we aggregate station columns and get the sum by each year. After we tidy the data, we finally get our transformed data “yearly_co2”.

```{r}
library(tidyr)
alt_yr <- aggregate(alt~Yr,monthly_co2,sum)
mlo_yr <- aggregate(mlo~Yr,monthly_co2,sum)
kum_yr <- aggregate(kum~Yr,monthly_co2,sum)
chr_yr <- aggregate(chr~Yr,monthly_co2,sum)
sam_yr <- aggregate(sam~Yr,monthly_co2,sum)
ker_yr <- aggregate(ker~Yr,monthly_co2,sum)
nzd_yr <- aggregate(nzd~Yr,monthly_co2,sum)
yearly_co2 <- merge(alt_yr,mlo_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,kum_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,chr_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,sam_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,ker_yr,all=TRUE)
yearly_co2 <- merge(yearly_co2,nzd_yr,all=TRUE)
yearly_co2_tidy <- yearly_co2 %>%
  pivot_longer(cols = !Yr, names_to = "station", 
               values_to = "CO2_concentration")
yearly_co2_tidy[351:360,]
```
